@page "/notes"
@using Shared.DTOs
@using Notely.Web.Services.AppServices
@inject INotesAppService NotesService
@inject NavigationManager NavigationManager

<PageTitle>Notes - Notely</PageTitle>

<div class="notes-container">
    <div class="notes-header">
        <h1 class="notes-title">
            <i class="fas fa-sticky-note"></i>
            My Notes
        </h1>
        <a href="/notes/create" class="btn-create-note">
            <i class="fas fa-plus"></i>
            Create New Note
        </a>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="loading-spinner"></div>
            <p class="mt-2">Loading notes...</p>
        </div>
    }
    else if (notes?.Any() == true)
    {
        <div class="notes-grid">
            @foreach (var note in notes)
            {
                <div class="note-card">
                    <div class="note-header">
                        <h3 class="note-title">
                            @if (note.IsPinned)
                            {
                                <i class="fas fa-thumbtack text-warning"></i>
                            }
                            @note.Title
                        </h3>
                        @if (!string.IsNullOrEmpty(note.CategoryName))
                        {
                            <span class="note-category">
                                <i class="fas fa-folder"></i>
                                @note.CategoryName
                            </span>
                        }
                    </div>
                    <div class="note-content">
                        @note.Content
                    </div>
                    @if (note.Tags?.Any() == true)
                    {
                        <div class="note-tags">
                            @foreach (var tag in note.Tags.Take(3))
                            {
                                <span class="note-tag">
                                    <i class="fas fa-tag"></i>
                                    @tag
                                </span>
                            }
                            @if (note.Tags.Count > 3)
                            {
                                <span class="note-tag-more">+@(note.Tags.Count - 3) more</span>
                            }
                        </div>
                    }
                    <div class="note-meta">
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i>
                            @note.CreatedAt.ToString("MMM dd, yyyy")
                            @if (note.UpdatedAt.HasValue)
                            {
                                <span class="updated-indicator">
                                    <i class="fas fa-edit"></i>
                                    Updated @note.UpdatedAt.Value.ToString("MMM dd")
                                </span>
                            }
                        </small>
                    </div>
                    <div class="note-actions">
                        <a href="/notes/details/@note.Id" class="btn-note-action btn-details">
                            <i class="fas fa-eye"></i>
                            Details
                        </a>
                        <a href="/notes/edit/@note.Id" class="btn-note-action btn-edit">
                            <i class="fas fa-edit"></i>
                            Edit
                        </a>
                        <button class="btn-note-action btn-delete" @onclick="() => DeleteNote(note.Id)">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-notes">
            <div class="empty-notes-icon">
                <i class="fas fa-sticky-note"></i>
            </div>
            <h2 class="empty-notes-title">No Notes Yet</h2>
            <p class="empty-notes-text">
                Create your first note to get started!
            </p>
            <a href="/notes/create" class="btn-create-note">
                <i class="fas fa-plus"></i>
                Create Your First Note
            </a>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private IEnumerable<NoteDto>? notes;

    protected override async Task OnInitializedAsync()
    {
        await LoadNotes();
    }

    private async Task LoadNotes()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            notes = await NotesService.GetAllNotesAsync();
        }
        catch
        {
            notes = new List<NoteDto>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task DeleteNote(Guid id)
    {
        if (await ConfirmDelete())
        {
            try
            {
                await NotesService.DeleteNoteAsync(id);
                await LoadNotes();
            }
            catch
            {
            }
        }
    }

    private async Task<bool> ConfirmDelete()
    {
        return await Task.FromResult(true);
    }
}
