@page "/notes/create"
@using Microsoft.AspNetCore.Components.Web
@using Notely.Web.Components
@using Shared.DTOs
@using Notely.Web.Services.AppServices
@using Microsoft.AspNetCore.Components.Forms
@inject INotesAppService NotesService
@inject NavigationManager NavigationManager

<PageTitle>Create Note - Notely</PageTitle>

<div class="note-editor">
    <div class="editor-header">
        <h1 class="editor-title">
            <i class="fas fa-plus-circle"></i>
            Create New Note
        </h1>
    </div>

    <EditForm Model="noteModel" OnValidSubmit="HandleValidSubmit" FormName="CreateNoteForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group">
            <label class="form-label" for="title">
                <i class="fas fa-heading"></i>
                Title
            </label>
            <InputText id="title" class="form-control" @bind-Value="noteModel.Title" placeholder="Enter note title..." />
            <ValidationMessage For="@(() => noteModel.Title)" />
        </div>

        <div class="form-group">
            <label class="form-label" for="content">
                <i class="fas fa-align-left"></i>
                Content
            </label>
            <InputTextArea id="content" class="form-control content-textarea" @bind-Value="noteModel.Content" placeholder="Write your note content here..." />
            <ValidationMessage For="@(() => noteModel.Content)" />
        </div>

        <div class="form-row">
            <div class="form-group">
                <div class="form-check">
                    <InputCheckbox id="isPinned" class="form-check-input" @bind-Value="noteModel.IsPinned" />
                    <label class="form-check-label" for="isPinned">
                        <i class="fas fa-thumbtack"></i>
                        Pin this note
                    </label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">
                <i class="fas fa-tags"></i>
                Tags
            </label>

            <TagSelector SelectedTag="@selectedTag"
                         SelectedTagChanged="OnTagChanged" />

            <small class="form-text text-muted">
                انتخاب یک تگ برای این یادداشت
            </small>
        </div>

        <div class="editor-actions">
            <a href="/notes" class="btn-cancel">
                <i class="fas fa-times"></i>
                Cancel
            </a>
            <button type="submit" class="btn-save" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Saving...</span>
                }
                else
                {
                    <i class="fas fa-save"></i>
                    <span>Save Note</span>
                }
            </button>
        </div>
    </EditForm>
</div>

@code {
    [SupplyParameterFromForm]
    private CreateNoteDto noteModel { get; set; } = null!;

    private bool isSubmitting = false;

    protected override void OnInitialized()
    {
        noteModel ??= new();
    }

    private string selectedTag = string.Empty;

    private void OnTagChanged(string tag)
    {
        selectedTag = tag ?? string.Empty;
    }

    private async Task HandleValidSubmit()
    {
        isSubmitting = true;
        StateHasChanged();

        try
        {
            noteModel.Tags = !string.IsNullOrEmpty(selectedTag) ? new List<string> { selectedTag } : new List<string>();
            await NotesService.CreateNoteAsync(noteModel);
            NavigationManager.NavigateTo("/notes");
        }
        catch
        {
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
}
