@page "/notes/edit/{id:guid}"
@using Shared.DTOs
@using Notely.Client.Services.Notes
@inject INotesService NotesService
@inject ICategoriesService CategoriesService
@inject ITagsService TagsService
@inject NavigationManager Navigation

<PageTitle>Edit Note</PageTitle>

<h1>Edit Note</h1>

@if (updateNoteDto == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-8">
            <EditForm Model="@updateNoteDto" OnValidSubmit="@HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label for="title" class="form-label">Title</label>
                    <InputText id="title" class="form-control" @bind-Value="updateNoteDto.Title" />
                    <ValidationMessage For="@(() => updateNoteDto.Title)" />
                </div>

                <div class="mb-3">
                    <label for="content" class="form-label">Content</label>
                    <InputTextArea id="content" class="form-control" rows="10" @bind-Value="updateNoteDto.Content" />
                    <ValidationMessage For="@(() => updateNoteDto.Content)" />
                </div>

                <div class="mb-3 form-check">
                    <InputCheckbox id="isPinned" class="form-check-input" @bind-Value="updateNoteDto.IsPinned" />
                    <label for="isPinned" class="form-check-label">
                        <i class="fas fa-thumbtack"></i> Pin this note
                    </label>
                </div>

                <div class="mb-3">
                    <label for="category" class="form-label">Category</label>
                    <InputSelect id="category" class="form-select" @bind-Value="updateNoteDto.CategoryId">
                        <option value="">Select a category (optional)</option>
                        @if (categories != null)
                        {
                            @foreach (var category in categories)
                            {
                                <option value="@category.Id">@category.Title</option>
                            }
                        }
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label class="form-label">Tags</label>
                    @if (availableTags.Any())
                    {
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            @foreach (var tag in availableTags.OrderBy(t => t.Title))
                            {
                                <div class="form-check form-check-inline">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        id="@($"tag_{tag.Id}")"
                                        checked="@selectedTags.Contains(tag.Title)"
                                        @onchange="(e) => OnTagCheckboxChanged(tag.Title, e)" />
                                    <label class="form-check-label" for="@($"tag_{tag.Id}")">@tag.Title</label>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="form-text">No tags available. Create tags from the Tags page.</div>
                    }
                </div>

                <div class="mb-3">
                    <button type="submit" class="btn btn-primary me-2" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        <i class="fas fa-save"></i> Update Note
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="Cancel">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    [Parameter] public Guid Id { get; set; }
    
    private UpdateNoteDto? updateNoteDto;
    private bool isSubmitting = false;
    private IEnumerable<CategoryDto>? categories;
    private IEnumerable<TagDto> availableTags = Enumerable.Empty<TagDto>();
    private readonly HashSet<string> selectedTags = new(StringComparer.OrdinalIgnoreCase);

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadNote(), LoadCategories(), LoadTags());
    }

    private async Task LoadCategories()
    {
        try
        {
            categories = await CategoriesService.GetCategoriesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading categories: {ex.Message}");
            categories = Enumerable.Empty<CategoryDto>();
        }
    }

    private async Task LoadTags()
    {
        try
        {
            availableTags = await TagsService.GetTagsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tags: {ex.Message}");
            availableTags = Enumerable.Empty<TagDto>();
        }
    }

    private async Task LoadNote()
    {
        try
        {
            var note = await NotesService.GetNoteAsync(Id);
            if (note != null)
            {
                updateNoteDto = new UpdateNoteDto
                {
                    Title = note.Title,
                    Content = note.Content,
                    IsPinned = note.IsPinned,
                    CategoryId = note.CategoryId,
                    Tags = note.Tags
                };

                selectedTags.Clear();
                foreach (var tag in note.Tags)
                {
                    selectedTags.Add(tag);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading note: {ex.Message}");
            Navigation.NavigateTo("/notes");
        }
    }

    private async Task HandleValidSubmit()
    {
        if (updateNoteDto == null) return;
        
        isSubmitting = true;
        try
        {
            ApplyTags();
            await NotesService.UpdateNoteAsync(Id, updateNoteDto);
            Navigation.NavigateTo("/notes");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating note: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/notes");
    }

    private void OnTagCheckboxChanged(string tagTitle, ChangeEventArgs args)
    {
        var isChecked = args.Value as bool? ?? false;
        if (isChecked)
        {
            selectedTags.Add(tagTitle);
            return;
        }

        selectedTags.Remove(tagTitle);
    }

    private void ApplyTags()
    {
        if (updateNoteDto == null)
        {
            return;
        }

        updateNoteDto.Tags = selectedTags.ToList();
    }
}
